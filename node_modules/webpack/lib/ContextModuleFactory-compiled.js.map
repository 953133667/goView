{"version":3,"sources":["ContextModuleFactory.js"],"names":[],"mappings":"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","file":"ContextModuleFactory-compiled.js","sourcesContent":["/*\r\n\tMIT License http://www.opensource.org/licenses/mit-license.php\r\n\tAuthor Tobias Koppers @sokra\r\n*/\r\nvar async = require(\"async\");\r\nvar path = require(\"path\");\r\n\r\nvar Tapable = require(\"tapable\");\r\nvar ContextModule = require(\"./ContextModule\");\r\nvar ContextElementDependency = require(\"./dependencies/ContextElementDependency\");\r\n\r\nfunction ContextModuleFactory(resolvers) {\r\n\tTapable.call(this);\r\n\tthis.resolvers = resolvers;\r\n}\r\nmodule.exports = ContextModuleFactory;\r\n\r\nContextModuleFactory.prototype = Object.create(Tapable.prototype);\r\nContextModuleFactory.prototype.constructor = ContextModuleFactory;\r\n\r\nContextModuleFactory.prototype.create = function(context, dependency, callback) {\r\n\tthis.applyPluginsAsyncWaterfall(\"before-resolve\", {\r\n\t\tcontext: context,\r\n\t\trequest: dependency.request,\r\n\t\trecursive: dependency.recursive,\r\n\t\tregExp: dependency.regExp\r\n\t}, function(err, result) {\r\n\t\tif(err) return callback(err);\r\n\r\n\t\t// Ignored\r\n\t\tif(!result) return callback();\r\n\r\n\t\tvar context = result.context;\r\n\t\tvar request = result.request;\r\n\t\tvar recursive = result.recursive;\r\n\t\tvar regExp = result.regExp;\r\n\r\n\t\tvar loaders, resource, loadersPrefix = \"\";\r\n\t\tvar idx = request.lastIndexOf(\"!\");\r\n\t\tif(idx >= 0) {\r\n\t\t\tloaders = request.substr(0, idx + 1);\r\n\t\t\tfor(var i = 0; i < loaders.length && loaders[i] === \"!\"; i++) {\r\n\t\t\t\tloadersPrefix += \"!\";\r\n\t\t\t}\r\n\t\t\tloaders = loaders.substr(i).replace(/!+$/, \"\").replace(/!!+/g, \"!\");\r\n\t\t\tif(loaders === \"\") loaders = [];\r\n\t\t\telse loaders = loaders.split(\"!\");\r\n\t\t\tresource = request.substr(idx + 1);\r\n\t\t} else {\r\n\t\t\tloaders = [];\r\n\t\t\tresource = request;\r\n\t\t}\r\n\r\n\t\tasync.parallel([\r\n\t\t\tthis.resolvers.context.resolve.bind(this.resolvers.context, context, resource),\r\n\t\t\tasync.map.bind(async, loaders, this.resolvers.loader.resolve.bind(this.resolvers.loader, context))\r\n\t\t], function(err, result) {\r\n\t\t\tif(err) return callback(err);\r\n\r\n\t\t\tthis.applyPluginsAsyncWaterfall(\"after-resolve\", {\r\n\t\t\t\tloaders: loadersPrefix + result[1].join(\"!\") + (result[1].length > 0 ? \"!\" : \"\"),\r\n\t\t\t\tresource: result[0],\r\n\t\t\t\trecursive: recursive,\r\n\t\t\t\tregExp: regExp,\r\n\t\t\t\tresolveDependencies: this.resolveDependencies.bind(this)\r\n\t\t\t}, function(err, result) {\r\n\t\t\t\tif(err) return callback(err);\r\n\r\n\t\t\t\t// Ignored\r\n\t\t\t\tif(!result) return callback();\r\n\r\n\t\t\t\treturn callback(null, new ContextModule(result.resolveDependencies, result.resource, result.recursive, result.regExp, result.loaders));\r\n\t\t\t});\r\n\t\t}.bind(this));\r\n\t}.bind(this));\r\n};\r\n\r\nContextModuleFactory.prototype.resolveDependencies = function resolveDependencies(fs, resource, recursive, regExp, callback) {\r\n\t(function addDirectory(directory, callback) {\r\n\t\tfs.readdir(directory, function(err, files) {\r\n\t\t\tif(err) return callback(err);\r\n\t\t\tif(!files || files.length === 0) return callback(null, []);\r\n\t\t\tasync.map(files.filter(function(p) {\r\n\t\t\t\treturn p.indexOf(\".\") !== 0;\r\n\t\t\t}), function(seqment, callback) {\r\n\r\n\t\t\t\tvar subResource = path.join(directory, seqment);\r\n\r\n\t\t\t\tfs.stat(subResource, function(err, stat) {\r\n\t\t\t\t\tif(err) return callback(err);\r\n\r\n\t\t\t\t\tif(stat.isDirectory()) {\r\n\r\n\t\t\t\t\t\tif(!recursive) return callback();\r\n\t\t\t\t\t\taddDirectory.call(this, subResource, callback);\r\n\r\n\t\t\t\t\t} else if(stat.isFile()) {\r\n\r\n\t\t\t\t\t\tvar obj = {\r\n\t\t\t\t\t\t\tcontext: resource,\r\n\t\t\t\t\t\t\trequest: \".\" + subResource.substr(resource.length).replace(/\\\\/g, \"/\")\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tthis.applyPluginsAsyncWaterfall(\"alternatives\", [obj], function(err, alternatives) {\r\n\t\t\t\t\t\t\tif(err) return callback(err);\r\n\t\t\t\t\t\t\talternatives = alternatives.filter(function(obj) {\r\n\t\t\t\t\t\t\t\treturn regExp.test(obj.request);\r\n\t\t\t\t\t\t\t}).map(function(obj) {\r\n\t\t\t\t\t\t\t\tvar dep = new ContextElementDependency(obj.request);\r\n\t\t\t\t\t\t\t\tdep.optional = true;\r\n\t\t\t\t\t\t\t\treturn dep;\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tcallback(null, alternatives);\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t} else callback();\r\n\r\n\t\t\t\t}.bind(this));\r\n\r\n\t\t\t}.bind(this), function(err, result) {\r\n\t\t\t\tif(err) return callback(err);\r\n\r\n\t\t\t\tif(!result) return callback(null, []);\r\n\r\n\t\t\t\tcallback(null, result.filter(function(i) {\r\n\t\t\t\t\treturn !!i;\r\n\t\t\t\t}).reduce(function(a, i) {\r\n\t\t\t\t\treturn a.concat(i);\r\n\t\t\t\t}, []));\r\n\t\t\t});\r\n\t\t}.bind(this));\r\n\t}.call(this, resource, callback));\r\n};\r\n"]}