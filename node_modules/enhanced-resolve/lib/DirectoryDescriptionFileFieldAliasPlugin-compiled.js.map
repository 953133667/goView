{"version":3,"sources":["DirectoryDescriptionFileFieldAliasPlugin.js"],"names":[],"mappings":"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","file":"DirectoryDescriptionFileFieldAliasPlugin-compiled.js","sourcesContent":["/*\r\n\tMIT License http://www.opensource.org/licenses/mit-license.php\r\n\tAuthor Tobias Koppers @sokra\r\n*/\r\nvar createInnerCallback = require(\"./createInnerCallback\");\r\n\r\nfunction DirectoryDescriptionFileFieldAliasPlugin(filename, field) {\r\n\tthis.filename = filename;\r\n\tthis.field = field;\r\n}\r\nmodule.exports = DirectoryDescriptionFileFieldAliasPlugin;\r\n\r\nfunction findDescriptionFileField(resolver, directory, filename, field, callback) {\r\n\t(function findDescriptionFile() {\r\n\t\tvar descriptionFilePath = resolver.join(directory, filename);\r\n\t\tresolver.fileSystem.readFile(descriptionFilePath, function(err, content) {\r\n\t\t\tif(err) {\r\n\t\t\t\tdirectory = cdUp(directory);\r\n\t\t\t\tif(!directory) {\r\n\t\t\t\t\treturn callback();\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn findDescriptionFile();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\ttry {\r\n\t\t\t\tcontent = JSON.parse(content);\r\n\t\t\t} catch(e) {\r\n\t\t\t\tif(callback.log)\r\n\t\t\t\t\tcallback.log(descriptionFilePath + \" (directory description file): \" + e);\r\n\t\t\t\telse\r\n\t\t\t\t\te.message = descriptionFilePath + \" (directory description file): \" + e;\r\n\t\t\t\treturn callback(e);\r\n\t\t\t}\r\n\t\t\tvar fieldData;\r\n\t\t\tif(Array.isArray(field)) {\r\n\t\t\t\tvar current = content;\r\n\t\t\t\tfor(var j = 0; j < field.length; j++) {\r\n\t\t\t\t\tif(current === null || typeof current !== \"object\") {\r\n\t\t\t\t\t\tcurrent = null;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcurrent = current[field[j]];\r\n\t\t\t\t}\r\n\t\t\t\tif(typeof current === \"object\") {\r\n\t\t\t\t\tfieldData = current;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif(typeof content[field] === \"object\") {\r\n\t\t\t\t\tfieldData = content[field];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(!fieldData) return callback();\r\n\t\t\tcallback(null, fieldData, directory);\r\n\t\t});\r\n\t}());\r\n}\r\n\r\nfunction cdUp(directory) {\r\n\tif(directory === \"/\") return null;\r\n\tvar i = directory.lastIndexOf(\"/\"),\r\n\t\tj = directory.lastIndexOf(\"\\\\\");\r\n\tvar p = i < 0 ? j : j < 0 ? i : i < j ? j : i;\r\n\tif(p < 0) return null;\r\n\treturn directory.substr(0, p || 1);\r\n}\r\n\r\nDirectoryDescriptionFileFieldAliasPlugin.prototype.apply = function(resolver) {\r\n\tvar filename = this.filename;\r\n\tvar field = this.field;\r\n\tresolver.plugin(\"module\", function(request, callback) {\r\n\t\tvar directory = request.path;\r\n\t\tvar moduleName = request.request;\r\n\t\tfindDescriptionFileField(this, directory, filename, field, function(err, fieldData, directory) {\r\n\t\t\tif(err) return callback(err);\r\n\t\t\tif(!fieldData) return callback();\r\n\t\t\tvar data = fieldData[moduleName];\r\n\t\t\tif(data === moduleName) return callback();\r\n\t\t\tif(data === false) return callback(null, {\r\n\t\t\t\tpath: false,\r\n\t\t\t\tresolved: true\r\n\t\t\t});\r\n\t\t\tif(!data) return callback();\r\n\t\t\tvar newRequest = this.parse(data);\r\n\t\t\tvar obj = {\r\n\t\t\t\tpath: directory,\r\n\t\t\t\trequest: newRequest.path,\r\n\t\t\t\tquery: newRequest.query,\r\n\t\t\t\tdirectory: newRequest.directory\r\n\t\t\t};\r\n\t\t\tvar newCallback = createInnerCallback(callback, callback, \"aliased from directory description file \" + this.join(directory, filename) + \" with mapping \" + JSON.stringify(moduleName));\r\n\t\t\tif(newRequest.module) return this.doResolve(\"module\", obj, newCallback);\r\n\t\t\tif(newRequest.directory) return this.doResolve(\"directory\", obj, newCallback);\r\n\t\t\treturn this.doResolve([\"file\", \"directory\"], obj, newCallback);\r\n\t\t}.bind(this));\r\n\t});\r\n\tresolver.plugin(\"result\", function(request, callback) {\r\n\t\tvar directory = cdUp(request.path);\r\n\t\tvar requestPath = request.path;\r\n\t\tfindDescriptionFileField(this, directory, filename, field, function(err, fieldData, directory) {\r\n\t\t\tif(err) return callback(err);\r\n\t\t\tif(!fieldData) return callback();\r\n\t\t\tvar relative = requestPath.substr(directory.length+1).replace(/\\\\/g, \"/\");\r\n\t\t\tif(typeof fieldData[relative] !== \"undefined\")\r\n\t\t\t\tvar data = fieldData[relative];\r\n\t\t\telse if(typeof fieldData[\"./\" + relative] !== \"undefined\")\r\n\t\t\t\tvar data = fieldData[\"./\" + relative];\r\n\t\t\tif(data === relative || data === \"./\" + relative) return callback();\r\n\t\t\tif(data === false) return callback(null, {\r\n\t\t\t\tpath: false,\r\n\t\t\t\tresolved: true\r\n\t\t\t});\r\n\t\t\tif(!data) return callback();\r\n\t\t\tvar newRequest = this.parse(data);\r\n\t\t\tvar obj = {\r\n\t\t\t\tpath: directory,\r\n\t\t\t\trequest: newRequest.path,\r\n\t\t\t\tquery: newRequest.query,\r\n\t\t\t\tdirectory: newRequest.directory\r\n\t\t\t};\r\n\t\t\tvar newCallback = createInnerCallback(callback, callback, \"aliased from directory description file \" + this.join(directory, filename) + \" with mapping \" + JSON.stringify(relative));\r\n\t\t\tif(newRequest.module) return this.doResolve(\"module\", obj, newCallback);\r\n\t\t\tif(newRequest.directory) return this.doResolve(\"directory\", obj, newCallback);\r\n\t\t\treturn this.doResolve([\"file\", \"directory\"], obj, newCallback);\r\n\t\t}.bind(this));\r\n\t});\r\n};\r\n"]}