{"version":3,"sources":["CachedInputFileSystem.js"],"names":[],"mappings":"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","file":"CachedInputFileSystem-compiled.js","sourcesContent":["/*\r\n\tMIT License http://www.opensource.org/licenses/mit-license.php\r\n\tAuthor Tobias Koppers @sokra\r\n*/\r\nfunction Storage(duration) {\r\n\tthis.duration = duration;\r\n\tthis.running = {};\r\n\tthis.data = {};\r\n\tthis.levels = [];\r\n\tif(duration > 0) {\r\n\t\tthis.levels.push([], [], [], [], [], [], [], [], []);\r\n\t\tfor(var i = 8000; i < duration; i+=500)\r\n\t\t\tthis.levels.push([]);\r\n\t}\r\n\tthis.count = 0;\r\n\tthis.interval = null;\r\n\tthis.needTickCheck = false;\r\n\tthis.nextTick = null;\r\n\tthis.passive = true;\r\n}\r\n\r\nStorage.prototype.ensureTick = function() {\r\n\tif(!this.interval && this.duration > 0 && !this.nextTick)\r\n\t\tthis.interval = setInterval(this.tick.bind(this), Math.floor(this.duration / this.levels.length));\r\n};\r\n\r\nStorage.prototype.finished = function(name) {\r\n\tvar args = Array.prototype.slice.call(arguments, 1);\r\n\tvar callbacks = this.running[name];\r\n\tdelete this.running[name];\r\n\tif(this.duration > 0) {\r\n\t\tthis.count++;\r\n\t\tthis.data[name] = args;\r\n\t\tthis.levels[0].push(name);\r\n\t\tthis.ensureTick();\r\n\t}\r\n\tfor(var i = 0; i < callbacks.length; i++) {\r\n\t\tcallbacks[i].apply(null, args);\r\n\t}\r\n};\r\n\r\nStorage.prototype.provide = function(name, provider, callback) {\r\n\tvar running = this.running[name];\r\n\tif(running) {\r\n\t\trunning.push(callback);\r\n\t\treturn;\r\n\t}\r\n\tif(this.duration > 0) {\r\n\t\tthis.checkTicks();\r\n\t\tvar data = this.data[name];\r\n\t\tif(data) {\r\n\t\t\treturn callback.apply(null, data);\r\n\t\t}\r\n\t}\r\n\tthis.running[name] = running = [callback];\r\n\tprovider(name, this.finished.bind(this, name));\r\n};\r\n\r\nStorage.prototype.tick = function() {\r\n\tvar decay = this.levels.pop();\r\n\tfor(var i = decay.length - 1; i >= 0; i--) {\r\n\t\tdelete this.data[decay[i]];\r\n\t}\r\n\tthis.count -= decay.length;\r\n\tdecay.length = 0;\r\n\tthis.levels.unshift(decay);\r\n\tif(this.count == 0) {\r\n\t\tclearInterval(this.interval);\r\n\t\tthis.interval = null;\r\n\t\tthis.nextTick = null;\r\n\t\treturn true;\r\n\t} else if(this.nextTick) {\r\n\t\tthis.nextTick += Math.floor(this.duration / this.levels.length);\r\n\t\tvar time = new Date().getTime();\r\n\t\tif(this.nextTick > time) {\r\n\t\t\tthis.nextTick = null;\r\n\t\t\tthis.interval = setInterval(this.tick.bind(this), Math.floor(this.duration / this.levels.length));\r\n\t\t\treturn true;\r\n\t\t}\r\n\t} else if(this.passive) {\r\n\t\tclearInterval(this.interval);\r\n\t\tthis.interval = null;\r\n\t\tthis.nextTick = new Date().getTime() + Math.floor(this.duration / this.levels.length);\r\n\t} else {\r\n\t\tthis.passive = true;\r\n\t}\r\n};\r\n\r\nStorage.prototype.checkTicks = function() {\r\n\tthis.passive = false;\r\n\tif(this.nextTick) {\r\n\t\twhile(!this.tick());\r\n\t}\r\n};\r\n\r\nStorage.prototype.purge = function(what) {\r\n\tif(!what) {\r\n\t\tthis.count = 0;\r\n\t\tclearInterval(this.interval);\r\n\t\tthis.nextTick = null;\r\n\t\tthis.data = {};\r\n\t\tthis.levels.forEach(function(level) {\r\n\t\t\tlevel.length = 0;\r\n\t\t});\r\n\t} else if(typeof what === \"string\") {\r\n\t\tObject.keys(this.data).forEach(function(key) {\r\n\t\t\tif(key.indexOf(what) === 0)\r\n\t\t\t\tdelete this.data[key];\r\n\t\t}, this);\r\n\t} else {\r\n\t\tfor(var i = what.length - 1; i >= 0; i--) {\r\n\t\t\tthis.purge(what[i]);\r\n\t\t}\r\n\t}\r\n};\r\n\r\n\r\nfunction CachedInputFileSystem(fileSystem, duration) {\r\n\tthis.fileSystem = fileSystem;\r\n\tthis._statStorage = new Storage(duration);\r\n\tthis._readdirStorage = new Storage(duration);\r\n\tthis._readFileStorage = new Storage(duration);\r\n\tthis._readlinkStorage = new Storage(duration);\r\n}\r\nmodule.exports = CachedInputFileSystem;\r\n\r\nCachedInputFileSystem.prototype.isSync = function() {\r\n\treturn this.fileSystem.isSync();\r\n};\r\n\r\nCachedInputFileSystem.prototype.stat = function(path, callback) {\r\n\tthis._statStorage.provide(path, this.fileSystem.stat.bind(this.fileSystem), callback);\r\n};\r\n\r\nCachedInputFileSystem.prototype.readdir = function(path, callback) {\r\n\tthis._readdirStorage.provide(path, this.fileSystem.readdir.bind(this.fileSystem), callback);\r\n};\r\n\r\nCachedInputFileSystem.prototype.readFile = function(path, callback) {\r\n\tthis._readFileStorage.provide(path, this.fileSystem.readFile.bind(this.fileSystem), callback);\r\n};\r\n\r\nCachedInputFileSystem.prototype.readlink = function(path, callback) {\r\n\tthis._readlinkStorage.provide(path, this.fileSystem.readlink.bind(this.fileSystem), callback);\r\n};\r\n\r\nCachedInputFileSystem.prototype.purge = function(what) {\r\n\tthis._statStorage.purge(what);\r\n\tthis._readdirStorage.purge(what);\r\n\tthis._readFileStorage.purge(what);\r\n\tthis._readlinkStorage.purge(what);\r\n};"]}