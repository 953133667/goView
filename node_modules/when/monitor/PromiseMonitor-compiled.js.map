{"version":3,"sources":["PromiseMonitor.js"],"names":[],"mappings":"AAAA;AACA;AACA;;AAEC,WAAS,MAAT,EAAiB;AAAE;;AACpB,QAAO,UAAS,OAAT,EAAkB;;AAExB,MAAI,4BAA4B,yBAAhC;AACA,MAAI,qBAAqB,0PAAzB;;AAEA,MAAI,WAAW,QAAQ,YAAR,EAAsB,QAArC;AACA,MAAI,QAAQ,QAAQ,SAAR,CAAZ;;AAEA,MAAI,mBAAmB,EAAvB;;AAEA,WAAS,cAAT,CAAwB,QAAxB,EAAkC;AACjC,QAAK,QAAL,GAAgB,CAAhB;AACA,QAAK,WAAL,GAAmB,kBAAnB;AACA,QAAK,kBAAL,GAA0B,yBAA1B;AACA,QAAK,qBAAL,GAA6B,IAA7B;;AAEA,QAAK,SAAL,GAAiB,QAAjB;AACA,OAAG,OAAO,SAAS,uBAAhB,KAA4C,UAA/C,EAA2D;AAC1D,aAAS,uBAAT,CAAiC,IAAjC;AACA;;AAED,QAAK,OAAL,GAAe,EAAf;AACA,QAAK,UAAL,GAAkB,CAAlB;;AAEA,OAAI,OAAO,IAAX;AACA,QAAK,YAAL,GAAoB,YAAW;AAC9B,SAAK,UAAL;AACA,IAFD;AAGA;;AAED,iBAAe,SAAf,CAAyB,OAAzB,GAAmC,UAAS,OAAT,EAAkB;AACpD,OAAI,OAAO,IAAX;AACA,WAAQ,aAAR,GAAwB,UAAS,CAAT,EAAY,OAAZ,EAAqB;AAC5C,MAAE,OAAF,GAAY,KAAK,aAAL,CAAmB,CAAnB,EAAsB,OAAtB,CAAZ;AACA,IAFD;;AAIA,WAAQ,YAAR,GAAuB,UAAS,CAAT,EAAY;AAClC,qBAAiB,IAAjB,CAAsB,EAAE,OAAxB;AACA,IAFD;;AAIA,WAAQ,WAAR,GAAsB,YAAW;AAChC,qBAAiB,GAAjB;AACA,IAFD;;AAIA,WAAQ,+BAAR,GAA0C,UAAS,SAAT,EAAoB,YAApB,EAAkC;AAC3E,WAAO,KAAK,QAAL,CAAc,SAAd,EAAyB,YAAzB,CAAP;AACA,IAFD;;AAIA,WAAQ,sCAAR,GAAiD,UAAS,SAAT,EAAoB;AACpE,WAAO,KAAK,WAAL,CAAiB,SAAjB,CAAP;AACA,IAFD;;AAIA,WAAQ,gBAAR,GAA2B,UAAS,SAAT,EAAoB,YAApB,EAAkC;AAC5D,WAAO,KAAK,KAAL,CAAW,SAAX,EAAsB,YAAtB,CAAP;AACA,IAFD;;AAIA,UAAO,IAAP;AACA,GA3BD;;AA6BA,iBAAe,SAAf,CAAyB,aAAzB,GAAyC,UAAS,EAAT,EAAa,aAAb,EAA4B;AACpE,OAAI,UAAU;AACb,YAAQ,iBAAiB,iBAAiB,iBAAiB,MAAjB,GAA0B,CAA3C,CADZ;AAEb,WAAO,KAAK;AAFC,IAAd;AAIA,SAAM,YAAN,CAAmB,OAAnB,EAA4B,GAAG,WAA/B;AACA,UAAO,OAAP;AACA,GAPD;;AASA,iBAAe,SAAf,CAAyB,QAAzB,GAAoC,UAAS,OAAT,EAAkB,YAAlB,EAAgC;AACnE,OAAI,CAAJ,EAAO,CAAP;;AAEA,QAAI,IAAI,KAAK,OAAL,CAAa,MAAb,GAAoB,CAA5B,EAA+B,KAAK,CAApC,EAAuC,EAAE,CAAzC,EAA4C;AAC3C,QAAI,KAAK,OAAL,CAAa,CAAb,CAAJ;AACA,QAAG,EAAE,OAAF,KAAc,OAAjB,EAA0B;AACzB;AACA;AACD;;AAED,OAAG,KAAK,CAAR,EAAW;AACV,MAAE,YAAF,GAAiB,YAAjB;AACA,IAFD,MAEO;AACN,SAAK,OAAL,CAAa,IAAb,CAAkB;AACjB,cAAS,OADQ;AAEjB,mBAAc;AAFG,KAAlB;AAIA;;AAED,QAAK,SAAL;AACA,GApBD;;AAsBA,iBAAe,SAAf,CAAyB,WAAzB,GAAuC,YAAS,WAAa;AAC5D,QAAK,SAAL;AACA,GAFD;;AAIA,iBAAe,SAAf,CAAyB,KAAzB,GAAiC,UAAS,OAAT,EAAkB,YAAlB,EAAgC;AAChE,OAAI,MAAM,IAAI,KAAJ,EAAV;AACA,OAAI,KAAJ,GAAY,KAAK,gBAAL,CAAsB,QAAQ,KAA9B,EAAqC,QAAQ,OAA7C,EAAsD,YAAtD,EAAoE,IAApE,CAAyE,IAAzE,CAAZ;AACA,YAAS,YAAW;AACnB,UAAM,GAAN;AACA,IAFD,EAEG,CAFH;AAGA,GAND;;AAQA,iBAAe,SAAf,CAAyB,SAAzB,GAAqC,YAAW;AAC/C,OAAG,CAAC,KAAK,UAAT,EAAqB;AACpB,SAAK,UAAL,GAAkB,SAAS,KAAK,YAAd,EAA4B,KAAK,QAAjC,CAAlB;AACA;AACD,GAJD;;AAMA,iBAAe,SAAf,CAAyB,UAAzB,GAAsC,YAAW;AAChD,QAAK,UAAL,GAAkB,KAAK,CAAvB;AACA,QAAK,OAAL,GAAe,KAAK,OAAL,CAAa,MAAb,CAAoB,aAApB,CAAf;AACA,QAAK,SAAL,CAAe,GAAf,CAAmB,KAAK,YAAL,CAAkB,KAAK,OAAvB,CAAnB;AACA,GAJD;;AAOA,iBAAe,SAAf,CAAyB,YAAzB,GAAwC,UAAS,MAAT,EAAiB;AACxD,UAAO,OAAO,GAAP,CAAW,UAAS,CAAT,EAAY;AAC7B,WAAO,KAAK,gBAAL,CAAsB,EAAE,OAAF,CAAU,KAAhC,EAAuC,EAAE,OAAF,CAAU,OAAjD,EAA0D,EAAE,YAA5D,CAAP;AACA,IAFM,EAEJ,IAFI,CAAP;AAGA,GAJD;;AAMA,iBAAe,SAAf,CAAyB,gBAAzB,GAA4C,UAAS,CAAT,EAAY,OAAZ,EAAqB,YAArB,EAAmC;AAC9E,OAAI,QAAQ,MAAM,KAAN,CAAY,CAAZ,KAAkB,CAAC,OAAO,CAAP,IAAY,4BAAb,CAA9B;AACA,WAAQ,aAAa,KAAK,WAAlB,EAA+B,KAA/B,EAAsC,CAAtC,CAAR;AACA,QAAK,cAAL,CAAoB,KAApB,EAA2B,OAA3B;AACA,QAAK,cAAL,CAAoB,KAApB,EAA2B,YAA3B;AACA,UAAO,KAAK,qBAAL,GAA6B,KAAK,iBAAL,CAAuB,KAAvB,CAA7B,GAA6D,KAApE;AACA,GAND;;AAQA,iBAAe,SAAf,CAAyB,iBAAzB,GAA6C,UAAS,KAAT,EAAgB;AAC5D,OAAI,OAAO,EAAX;AACA,OAAI,MAAM,KAAK,kBAAf;AACA,OAAI,QAAQ,CAAZ;AACA,UAAO,MAAM,WAAN,CAAkB,UAAS,OAAT,EAAkB,IAAlB,EAAwB,CAAxB,EAA2B;AACnD,QAAG,MAAM,CAAT,EAAY;AACX,aAAQ,OAAR,CAAgB,IAAhB;AACA,KAFD,MAEO,IAAG,SAAS,GAAZ,EAAiB;AACvB,SAAG,QAAQ,CAAX,EAAc;AACb,cAAQ,OAAR,CAAgB,IAAhB;AACA,cAAQ,CAAR;AACA;AACD,KALM,MAKA,IAAG,CAAC,KAAK,IAAL,CAAJ,EAAgB;AACtB,UAAK,IAAL,IAAa,IAAb;AACA,aAAQ,OAAR,CAAgB,IAAhB;AACA,OAAE,KAAF;AACA;AACD,WAAO,OAAP;AACA,IAdM,EAcJ,EAdI,CAAP;AAeA,GAnBD;;AAqBA,iBAAe,SAAf,CAAyB,cAAzB,GAA0C,UAAS,KAAT,EAAgB,OAAhB,EAAyB;AAClE,SAAM,IAAN,CAAW,KAAX,CAAiB,KAAjB,EAAwB,KAAK,YAAL,CAAkB,OAAlB,CAAxB;AACA,GAFD;;AAIA,iBAAe,SAAf,CAAyB,YAAzB,GAAwC,UAAS,UAAT,EAAqB;AAC5D,OAAI,QAAQ,EAAZ;AACA,OAAI,KAAJ;;AAEA,UAAM,UAAN,EAAkB;AACjB,YAAQ,MAAM,KAAN,CAAY,UAAZ,CAAR;;AAEA,QAAI,KAAJ,EAAW;AACV,aAAQ,aAAa,KAAK,WAAlB,EAA+B,KAA/B,CAAR;AACA,iBAAY,KAAZ,EAAmB,KAAnB,EAA0B,KAAK,kBAA/B;AACA;;AAED,iBAAa,WAAW,MAAxB;AACA;;AAED,UAAO,KAAP;AACA,GAhBD;;AAkBA,WAAS,WAAT,CAAqB,KAArB,EAA4B,KAA5B,EAAmC,SAAnC,EAA8C;AAC7C,OAAI,MAAM,MAAN,GAAe,CAAnB,EAAsB;AACrB,UAAM,CAAN,IAAW,SAAX;AACA,UAAM,IAAN,CAAW,KAAX,CAAiB,KAAjB,EAAwB,KAAxB;AACA;AACD;;AAED,WAAS,YAAT,CAAsB,WAAtB,EAAmC,KAAnC,EAA0C;AACzC,UAAO,MAAM,MAAN,CAAa,UAAS,KAAT,EAAgB;AACnC,WAAO,CAAC,YAAY,IAAZ,CAAiB,KAAjB,CAAR;AACA,IAFM,CAAP;AAGA;;AAED,WAAS,aAAT,CAAuB,CAAvB,EAA0B;AACzB,UAAO,CAAC,EAAE,OAAF,CAAU,OAAlB;AACA;;AAED,SAAO,cAAP;AACA,EA9LD;AA+LC,CAhMA,EAgMC,OAAO,MAAP,KAAkB,UAAlB,IAAgC,OAAO,GAAvC,GAA6C,MAA7C,GAAsD,UAAS,OAAT,EAAkB;AAAE,QAAO,OAAP,GAAiB,QAAQ,OAAR,CAAjB;AAAoC,CAhM/G,CAAD","file":"PromiseMonitor-compiled.js","sourcesContent":["/** @license MIT License (c) copyright 2010-2014 original author or authors */\n/** @author Brian Cavalier */\n/** @author John Hann */\n\n(function(define) { 'use strict';\ndefine(function(require) {\n\n\tvar defaultStackJumpSeparator = 'from execution context:';\n\tvar defaultStackFilter = /[\\s\\(\\/\\\\](node|module|timers)\\.js:|when([\\/\\\\]{1,2}(lib|monitor|es6-shim)[\\/\\\\]{1,2}|\\.js)|(new\\sPromise)\\b|(\\b(PromiseMonitor|ConsoleReporter|Scheduler|RunHandlerTask|ProgressTask|Promise|.*Handler)\\.[\\w_]\\w\\w+\\b)|\\b(tryCatch\\w+|getHandler\\w*)\\b/i;\n\n\tvar setTimer = require('../lib/env').setTimer;\n\tvar error = require('./error');\n\n\tvar executionContext = [];\n\n\tfunction PromiseMonitor(reporter) {\n\t\tthis.logDelay = 0;\n\t\tthis.stackFilter = defaultStackFilter;\n\t\tthis.stackJumpSeparator = defaultStackJumpSeparator;\n\t\tthis.filterDuplicateFrames = true;\n\n\t\tthis._reporter = reporter;\n\t\tif(typeof reporter.configurePromiseMonitor === 'function') {\n\t\t\treporter.configurePromiseMonitor(this);\n\t\t}\n\n\t\tthis._traces = [];\n\t\tthis._traceTask = 0;\n\n\t\tvar self = this;\n\t\tthis._doLogTraces = function() {\n\t\t\tself._logTraces();\n\t\t};\n\t}\n\n\tPromiseMonitor.prototype.monitor = function(Promise) {\n\t\tvar self = this;\n\t\tPromise.createContext = function(p, context) {\n\t\t\tp.context = self.createContext(p, context);\n\t\t};\n\n\t\tPromise.enterContext = function(p) {\n\t\t\texecutionContext.push(p.context);\n\t\t};\n\n\t\tPromise.exitContext = function() {\n\t\t\texecutionContext.pop();\n\t\t};\n\n\t\tPromise.onPotentiallyUnhandledRejection = function(rejection, extraContext) {\n\t\t\treturn self.addTrace(rejection, extraContext);\n\t\t};\n\n\t\tPromise.onPotentiallyUnhandledRejectionHandled = function(rejection) {\n\t\t\treturn self.removeTrace(rejection);\n\t\t};\n\n\t\tPromise.onFatalRejection = function(rejection, extraContext) {\n\t\t\treturn self.fatal(rejection, extraContext);\n\t\t};\n\n\t\treturn this;\n\t};\n\n\tPromiseMonitor.prototype.createContext = function(at, parentContext) {\n\t\tvar context = {\n\t\t\tparent: parentContext || executionContext[executionContext.length - 1],\n\t\t\tstack: void 0\n\t\t};\n\t\terror.captureStack(context, at.constructor);\n\t\treturn context;\n\t};\n\n\tPromiseMonitor.prototype.addTrace = function(handler, extraContext) {\n\t\tvar t, i;\n\n\t\tfor(i = this._traces.length-1; i >= 0; --i) {\n\t\t\tt = this._traces[i];\n\t\t\tif(t.handler === handler) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif(i >= 0) {\n\t\t\tt.extraContext = extraContext;\n\t\t} else {\n\t\t\tthis._traces.push({\n\t\t\t\thandler: handler,\n\t\t\t\textraContext: extraContext\n\t\t\t});\n\t\t}\n\n\t\tthis.logTraces();\n\t};\n\n\tPromiseMonitor.prototype.removeTrace = function(/*handler*/) {\n\t\tthis.logTraces();\n\t};\n\n\tPromiseMonitor.prototype.fatal = function(handler, extraContext) {\n\t\tvar err = new Error();\n\t\terr.stack = this._createLongTrace(handler.value, handler.context, extraContext).join('\\n');\n\t\tsetTimer(function() {\n\t\t\tthrow err;\n\t\t}, 0);\n\t};\n\n\tPromiseMonitor.prototype.logTraces = function() {\n\t\tif(!this._traceTask) {\n\t\t\tthis._traceTask = setTimer(this._doLogTraces, this.logDelay);\n\t\t}\n\t};\n\n\tPromiseMonitor.prototype._logTraces = function() {\n\t\tthis._traceTask = void 0;\n\t\tthis._traces = this._traces.filter(filterHandled);\n\t\tthis._reporter.log(this.formatTraces(this._traces));\n\t};\n\n\n\tPromiseMonitor.prototype.formatTraces = function(traces) {\n\t\treturn traces.map(function(t) {\n\t\t\treturn this._createLongTrace(t.handler.value, t.handler.context, t.extraContext);\n\t\t}, this);\n\t};\n\n\tPromiseMonitor.prototype._createLongTrace = function(e, context, extraContext) {\n\t\tvar trace = error.parse(e) || [String(e) + ' (WARNING: non-Error used)'];\n\t\ttrace = filterFrames(this.stackFilter, trace, 0);\n\t\tthis._appendContext(trace, context);\n\t\tthis._appendContext(trace, extraContext);\n\t\treturn this.filterDuplicateFrames ? this._removeDuplicates(trace) : trace;\n\t};\n\n\tPromiseMonitor.prototype._removeDuplicates = function(trace) {\n\t\tvar seen = {};\n\t\tvar sep = this.stackJumpSeparator;\n\t\tvar count = 0;\n\t\treturn trace.reduceRight(function(deduped, line, i) {\n\t\t\tif(i === 0) {\n\t\t\t\tdeduped.unshift(line);\n\t\t\t} else if(line === sep) {\n\t\t\t\tif(count > 0) {\n\t\t\t\t\tdeduped.unshift(line);\n\t\t\t\t\tcount = 0;\n\t\t\t\t}\n\t\t\t} else if(!seen[line]) {\n\t\t\t\tseen[line] = true;\n\t\t\t\tdeduped.unshift(line);\n\t\t\t\t++count;\n\t\t\t}\n\t\t\treturn deduped;\n\t\t}, []);\n\t};\n\n\tPromiseMonitor.prototype._appendContext = function(trace, context) {\n\t\ttrace.push.apply(trace, this._createTrace(context));\n\t};\n\n\tPromiseMonitor.prototype._createTrace = function(traceChain) {\n\t\tvar trace = [];\n\t\tvar stack;\n\n\t\twhile(traceChain) {\n\t\t\tstack = error.parse(traceChain);\n\n\t\t\tif (stack) {\n\t\t\t\tstack = filterFrames(this.stackFilter, stack);\n\t\t\t\tappendStack(trace, stack, this.stackJumpSeparator);\n\t\t\t}\n\n\t\t\ttraceChain = traceChain.parent;\n\t\t}\n\n\t\treturn trace;\n\t};\n\n\tfunction appendStack(trace, stack, separator) {\n\t\tif (stack.length > 1) {\n\t\t\tstack[0] = separator;\n\t\t\ttrace.push.apply(trace, stack);\n\t\t}\n\t}\n\n\tfunction filterFrames(stackFilter, stack) {\n\t\treturn stack.filter(function(frame) {\n\t\t\treturn !stackFilter.test(frame);\n\t\t});\n\t}\n\n\tfunction filterHandled(t) {\n\t\treturn !t.handler.handled;\n\t}\n\n\treturn PromiseMonitor;\n});\n}(typeof define === 'function' && define.amd ? define : function(factory) { module.exports = factory(require); }));\n"]}