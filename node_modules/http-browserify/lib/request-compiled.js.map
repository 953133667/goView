{"version":3,"sources":["request.js"],"names":[],"mappings":"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","file":"request-compiled.js","sourcesContent":["var Stream = require('stream');\nvar Response = require('./response');\nvar Base64 = require('Base64');\nvar inherits = require('inherits');\n\nvar Request = module.exports = function (xhr, params) {\n    var self = this;\n    self.writable = true;\n    self.xhr = xhr;\n    self.body = [];\n    \n    self.uri = (params.protocol || 'http:') + '//'\n        + params.host\n        + (params.port ? ':' + params.port : '')\n        + (params.path || '/')\n    ;\n    \n    if (typeof params.withCredentials === 'undefined') {\n        params.withCredentials = true;\n    }\n\n    try { xhr.withCredentials = params.withCredentials }\n    catch (e) {}\n    \n    if (params.responseType) try { xhr.responseType = params.responseType }\n    catch (e) {}\n    \n    xhr.open(\n        params.method || 'GET',\n        self.uri,\n        true\n    );\n\n    xhr.onerror = function(event) {\n        self.emit('error', new Error('Network error'));\n    };\n\n    self._headers = {};\n    \n    if (params.headers) {\n        var keys = objectKeys(params.headers);\n        for (var i = 0; i < keys.length; i++) {\n            var key = keys[i];\n            if (!self.isSafeRequestHeader(key)) continue;\n            var value = params.headers[key];\n            self.setHeader(key, value);\n        }\n    }\n    \n    if (params.auth) {\n        //basic auth\n        this.setHeader('Authorization', 'Basic ' + Base64.btoa(params.auth));\n    }\n\n    var res = new Response;\n    res.on('close', function () {\n        self.emit('close');\n    });\n    \n    res.on('ready', function () {\n        self.emit('response', res);\n    });\n\n    res.on('error', function (err) {\n        self.emit('error', err);\n    });\n    \n    xhr.onreadystatechange = function () {\n        // Fix for IE9 bug\n        // SCRIPT575: Could not complete the operation due to error c00c023f\n        // It happens when a request is aborted, calling the success callback anyway with readyState === 4\n        if (xhr.__aborted) return;\n        res.handle(xhr);\n    };\n};\n\ninherits(Request, Stream);\n\nRequest.prototype.setHeader = function (key, value) {\n    this._headers[key.toLowerCase()] = value\n};\n\nRequest.prototype.getHeader = function (key) {\n    return this._headers[key.toLowerCase()]\n};\n\nRequest.prototype.removeHeader = function (key) {\n    delete this._headers[key.toLowerCase()]\n};\n\nRequest.prototype.write = function (s) {\n    this.body.push(s);\n};\n\nRequest.prototype.destroy = function (s) {\n    this.xhr.__aborted = true;\n    this.xhr.abort();\n    this.emit('close');\n};\n\nRequest.prototype.end = function (s) {\n    if (s !== undefined) this.body.push(s);\n\n    var keys = objectKeys(this._headers);\n    for (var i = 0; i < keys.length; i++) {\n        var key = keys[i];\n        var value = this._headers[key];\n        if (isArray(value)) {\n            for (var j = 0; j < value.length; j++) {\n                this.xhr.setRequestHeader(key, value[j]);\n            }\n        }\n        else this.xhr.setRequestHeader(key, value)\n    }\n\n    if (this.body.length === 0) {\n        this.xhr.send('');\n    }\n    else if (typeof this.body[0] === 'string') {\n        this.xhr.send(this.body.join(''));\n    }\n    else if (isArray(this.body[0])) {\n        var body = [];\n        for (var i = 0; i < this.body.length; i++) {\n            body.push.apply(body, this.body[i]);\n        }\n        this.xhr.send(body);\n    }\n    else if (/Array/.test(Object.prototype.toString.call(this.body[0]))) {\n        var len = 0;\n        for (var i = 0; i < this.body.length; i++) {\n            len += this.body[i].length;\n        }\n        var body = new(this.body[0].constructor)(len);\n        var k = 0;\n        \n        for (var i = 0; i < this.body.length; i++) {\n            var b = this.body[i];\n            for (var j = 0; j < b.length; j++) {\n                body[k++] = b[j];\n            }\n        }\n        this.xhr.send(body);\n    }\n    else if (isXHR2Compatible(this.body[0])) {\n        this.xhr.send(this.body[0]);\n    }\n    else {\n        var body = '';\n        for (var i = 0; i < this.body.length; i++) {\n            body += this.body[i].toString();\n        }\n        this.xhr.send(body);\n    }\n};\n\n// Taken from http://dxr.mozilla.org/mozilla/mozilla-central/content/base/src/nsXMLHttpRequest.cpp.html\nRequest.unsafeHeaders = [\n    \"accept-charset\",\n    \"accept-encoding\",\n    \"access-control-request-headers\",\n    \"access-control-request-method\",\n    \"connection\",\n    \"content-length\",\n    \"cookie\",\n    \"cookie2\",\n    \"content-transfer-encoding\",\n    \"date\",\n    \"expect\",\n    \"host\",\n    \"keep-alive\",\n    \"origin\",\n    \"referer\",\n    \"te\",\n    \"trailer\",\n    \"transfer-encoding\",\n    \"upgrade\",\n    \"user-agent\",\n    \"via\"\n];\n\nRequest.prototype.isSafeRequestHeader = function (headerName) {\n    if (!headerName) return false;\n    return indexOf(Request.unsafeHeaders, headerName.toLowerCase()) === -1;\n};\n\nvar objectKeys = Object.keys || function (obj) {\n    var keys = [];\n    for (var key in obj) keys.push(key);\n    return keys;\n};\n\nvar isArray = Array.isArray || function (xs) {\n    return Object.prototype.toString.call(xs) === '[object Array]';\n};\n\nvar indexOf = function (xs, x) {\n    if (xs.indexOf) return xs.indexOf(x);\n    for (var i = 0; i < xs.length; i++) {\n        if (xs[i] === x) return i;\n    }\n    return -1;\n};\n\nvar isXHR2Compatible = function (obj) {\n    if (typeof Blob !== 'undefined' && obj instanceof Blob) return true;\n    if (typeof ArrayBuffer !== 'undefined' && obj instanceof ArrayBuffer) return true;\n    if (typeof FormData !== 'undefined' && obj instanceof FormData) return true;\n};\n"]}