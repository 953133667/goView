{"version":3,"sources":["comments-processor.js"],"names":[],"mappings":"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","file":"comments-processor-compiled.js","sourcesContent":["var EscapeStore = require('./escape-store');\nvar QuoteScanner = require('../utils/quote-scanner');\n\nvar SPECIAL_COMMENT_PREFIX = '/*!';\nvar COMMENT_PREFIX = '/*';\nvar COMMENT_SUFFIX = '*/';\n\nvar lineBreak = require('os').EOL;\n\nfunction CommentsProcessor(context, keepSpecialComments, keepBreaks, saveWaypoints) {\n  this.comments = new EscapeStore('COMMENT');\n  this.specialComments = new EscapeStore('COMMENT_SPECIAL');\n\n  this.context = context;\n  this.restored = 0;\n  this.keepAll = keepSpecialComments == '*';\n  this.keepOne = keepSpecialComments == '1' || keepSpecialComments === 1;\n  this.keepBreaks = keepBreaks;\n  this.saveWaypoints = saveWaypoints;\n}\n\nfunction quoteScannerFor(data) {\n  var quoteMap = [];\n  new QuoteScanner(data).each(function (quotedString, _, startsAt) {\n    quoteMap.push([startsAt, startsAt + quotedString.length]);\n  });\n\n  return function (position) {\n    for (var i = 0, l = quoteMap.length; i < l; i++) {\n      if (quoteMap[i][0] < position && quoteMap[i][1] > position)\n        return true;\n    }\n\n    return false;\n  };\n}\n\nCommentsProcessor.prototype.escape = function (data) {\n  var tempData = [];\n  var nextStart = 0;\n  var nextEnd = 0;\n  var cursor = 0;\n  var indent = 0;\n  var breaksCount;\n  var lastBreakAt;\n  var newIndent;\n  var isQuotedAt = quoteScannerFor(data);\n  var saveWaypoints = this.saveWaypoints;\n\n  for (; nextEnd < data.length;) {\n    nextStart = data.indexOf(COMMENT_PREFIX, cursor);\n    if (nextStart == -1)\n      break;\n\n    if (isQuotedAt(nextStart)) {\n      tempData.push(data.substring(cursor, nextStart + COMMENT_PREFIX.length));\n      cursor = nextStart + COMMENT_PREFIX.length;\n      continue;\n    }\n\n    nextEnd = data.indexOf(COMMENT_SUFFIX, nextStart + COMMENT_PREFIX.length);\n    if (nextEnd == -1) {\n      this.context.warnings.push('Broken comment: \\'' + data.substring(nextStart) + '\\'.');\n      nextEnd = data.length - 2;\n    }\n\n    tempData.push(data.substring(cursor, nextStart));\n\n    var comment = data.substring(nextStart, nextEnd + COMMENT_SUFFIX.length);\n    var isSpecialComment = comment.indexOf(SPECIAL_COMMENT_PREFIX) === 0;\n\n    if (saveWaypoints) {\n      breaksCount = comment.split(lineBreak).length - 1;\n      lastBreakAt = comment.lastIndexOf(lineBreak);\n      newIndent = lastBreakAt > 0 ?\n        comment.substring(lastBreakAt + lineBreak.length).length :\n        indent + comment.length;\n    }\n\n    if (saveWaypoints || isSpecialComment) {\n      var metadata = saveWaypoints ? [breaksCount, newIndent] : null;\n      var placeholder = isSpecialComment ?\n        this.specialComments.store(comment, metadata) :\n        this.comments.store(comment, metadata);\n      tempData.push(placeholder);\n    }\n\n    if (saveWaypoints)\n      indent = newIndent + 1;\n    cursor = nextEnd + COMMENT_SUFFIX.length;\n  }\n\n  return tempData.length > 0 ?\n    tempData.join('') + data.substring(cursor, data.length) :\n    data;\n};\n\nfunction restore(context, data, from, isSpecial) {\n  var tempData = [];\n  var cursor = 0;\n\n  for (; cursor < data.length;) {\n    var nextMatch = from.nextMatch(data, cursor);\n    if (nextMatch.start < 0)\n      break;\n\n    tempData.push(data.substring(cursor, nextMatch.start));\n    var comment = from.restore(nextMatch.match);\n\n    if (isSpecial && (context.keepAll || (context.keepOne && context.restored === 0))) {\n      context.restored++;\n      tempData.push(comment);\n\n      cursor = nextMatch.end;\n    } else {\n      cursor = nextMatch.end + (context.keepBreaks && data.substring(nextMatch.end, nextMatch.end + lineBreak.length) == lineBreak ? lineBreak.length : 0);\n    }\n  }\n\n  return tempData.length > 0 ?\n    tempData.join('') + data.substring(cursor, data.length) :\n    data;\n}\n\nCommentsProcessor.prototype.restore = function (data) {\n  data = restore(this, data, this.comments, false);\n  data = restore(this, data, this.specialComments, true);\n  return data;\n};\n\nmodule.exports = CommentsProcessor;\n"]}