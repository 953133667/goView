{"version":3,"sources":["import-visitor.js"],"names":[],"mappings":"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","file":"import-visitor-compiled.js","sourcesContent":["var contexts = require(\"../contexts\"),\n    Visitor = require(\"./visitor\"),\n    ImportSequencer = require(\"./import-sequencer\");\n\nvar ImportVisitor = function(importer, finish) {\n\n    this._visitor = new Visitor(this);\n    this._importer = importer;\n    this._finish = finish;\n    this.context = new contexts.Eval();\n    this.importCount = 0;\n    this.onceFileDetectionMap = {};\n    this.recursionDetector = {};\n    this._sequencer = new ImportSequencer(this._onSequencerEmpty.bind(this));\n};\n\nImportVisitor.prototype = {\n    isReplacing: false,\n    run: function (root) {\n        try {\n            // process the contents\n            this._visitor.visit(root);\n        }\n        catch(e) {\n            this.error = e;\n        }\n\n        this.isFinished = true;\n        this._sequencer.tryRun();\n    },\n    _onSequencerEmpty: function() {\n        if (!this.isFinished) {\n            return;\n        }\n        this._finish(this.error);\n    },\n    visitImport: function (importNode, visitArgs) {\n        var inlineCSS = importNode.options.inline;\n\n        if (!importNode.css || inlineCSS) {\n\n            var context = new contexts.Eval(this.context, this.context.frames.slice(0));\n            var importParent = context.frames[0];\n\n            this.importCount++;\n            if (importNode.isVariableImport()) {\n                this._sequencer.addVariableImport(this.processImportNode.bind(this, importNode, context, importParent));\n            } else {\n                this.processImportNode(importNode, context, importParent);\n            }\n        }\n        visitArgs.visitDeeper = false;\n    },\n    processImportNode: function(importNode, context, importParent) {\n        var evaldImportNode,\n            inlineCSS = importNode.options.inline;\n\n        try {\n            evaldImportNode = importNode.evalForImport(context);\n        } catch(e) {\n            if (!e.filename) { e.index = importNode.index; e.filename = importNode.currentFileInfo.filename; }\n            // attempt to eval properly and treat as css\n            importNode.css = true;\n            // if that fails, this error will be thrown\n            importNode.error = e;\n        }\n\n        if (evaldImportNode && (!evaldImportNode.css || inlineCSS)) {\n\n            if (evaldImportNode.options.multiple) {\n                context.importMultiple = true;\n            }\n\n            // try appending if we haven't determined if it is css or not\n            var tryAppendLessExtension = evaldImportNode.css === undefined;\n\n            for (var i = 0; i < importParent.rules.length; i++) {\n                if (importParent.rules[i] === importNode) {\n                    importParent.rules[i] = evaldImportNode;\n                    break;\n                }\n            }\n\n            var onImported = this.onImported.bind(this, evaldImportNode, context),\n                sequencedOnImported = this._sequencer.addImport(onImported);\n\n            this._importer.push(evaldImportNode.getPath(), tryAppendLessExtension, evaldImportNode.currentFileInfo,\n                evaldImportNode.options, sequencedOnImported);\n        } else {\n            this.importCount--;\n            if (this.isFinished) {\n                this._sequencer.tryRun();\n            }\n        }\n    },\n    onImported: function (importNode, context, e, root, importedAtRoot, fullPath) {\n        if (e) {\n            if (!e.filename) {\n                e.index = importNode.index; e.filename = importNode.currentFileInfo.filename;\n            }\n            this.error = e;\n        }\n\n        var importVisitor = this,\n            inlineCSS = importNode.options.inline,\n            isPlugin = importNode.options.plugin,\n            isOptional = importNode.options.optional,\n            duplicateImport = importedAtRoot || fullPath in importVisitor.recursionDetector;\n\n        if (!context.importMultiple) {\n            if (duplicateImport) {\n                importNode.skip = true;\n            } else {\n                importNode.skip = function() {\n                    if (fullPath in importVisitor.onceFileDetectionMap) {\n                        return true;\n                    }\n                    importVisitor.onceFileDetectionMap[fullPath] = true;\n                    return false;\n                };\n            }\n        }\n\n        if (!fullPath && isOptional) {\n            importNode.skip = true;\n        }\n\n        if (root) {\n            importNode.root = root;\n            importNode.importedFilename = fullPath;\n\n            if (!inlineCSS && !isPlugin && (context.importMultiple || !duplicateImport)) {\n                importVisitor.recursionDetector[fullPath] = true;\n\n                var oldContext = this.context;\n                this.context = context;\n                try {\n                    this._visitor.visit(root);\n                } catch (e) {\n                    this.error = e;\n                }\n                this.context = oldContext;\n            }\n        }\n\n        importVisitor.importCount--;\n\n        if (importVisitor.isFinished) {\n            importVisitor._sequencer.tryRun();\n        }\n    },\n    visitRule: function (ruleNode, visitArgs) {\n        if (ruleNode.value.type === \"DetachedRuleset\") {\n            this.context.frames.unshift(ruleNode);\n        } else {\n            visitArgs.visitDeeper = false;\n        }\n    },\n    visitRuleOut : function(ruleNode) {\n        if (ruleNode.value.type === \"DetachedRuleset\") {\n            this.context.frames.shift();\n        }\n    },\n    visitDirective: function (directiveNode, visitArgs) {\n        this.context.frames.unshift(directiveNode);\n    },\n    visitDirectiveOut: function (directiveNode) {\n        this.context.frames.shift();\n    },\n    visitMixinDefinition: function (mixinDefinitionNode, visitArgs) {\n        this.context.frames.unshift(mixinDefinitionNode);\n    },\n    visitMixinDefinitionOut: function (mixinDefinitionNode) {\n        this.context.frames.shift();\n    },\n    visitRuleset: function (rulesetNode, visitArgs) {\n        this.context.frames.unshift(rulesetNode);\n    },\n    visitRulesetOut: function (rulesetNode) {\n        this.context.frames.shift();\n    },\n    visitMedia: function (mediaNode, visitArgs) {\n        this.context.frames.unshift(mediaNode.rules[0]);\n    },\n    visitMediaOut: function (mediaNode) {\n        this.context.frames.shift();\n    }\n};\nmodule.exports = ImportVisitor;\n"]}